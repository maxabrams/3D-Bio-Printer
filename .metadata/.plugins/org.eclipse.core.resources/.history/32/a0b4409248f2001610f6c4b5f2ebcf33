//import com.pi4j.io.gpio.*;
import java.io.*;

import javax.swing.JLabel;


public class TempControl implements Runnable {
    private volatile boolean running = true;
    private double threshold = 2;
    private double target = 20;
    private boolean isRelayOn = false;
    private static int RELAY_PIN = 18;
  //  private GPIO_Pin relay;
   // private GpioController gpio;
   // private GpioPinDigitalOutput pin;
    private static final String PATH_TO_TEMP = "/home/pi/Adafruit_Python_DHT/examples/AdafruitDHT.py";
    private static final String PATH_TO_RELAY_OFF = "/src/py/relay_off.py";
    private static final String PATH_TO_RELAY_ON = "/src/py/relay_on.py";
    JLabel output;
    
    public TempControl(JLabel label){
    	output = label;
        //relay = new GPIO_Pin(RELAY_PIN);
       /* gpio = GpioFactory.getInstance();
        pin = gpio.provisionDigitalOutputPin(RaspiPin.GPIO_18, "Relay", PinState.LOW);
        pin.setShutdownOptions(true, PinState.LOW);
        */
    }
    
    @Override
    public void run() {

        while (running) {
            double currTemp = getTemp();
            
            if(currTemp< target - threshold){
                heaterOn();
            }else{ //if(currTemp >= target)
                heaterOff();
            }
            
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                System.out.println("Could not sleep!");
            }
           
            output.setText("Current Temp: ");// + currTemp);
            System.out.println("Current Temp: " + currTemp);
        }
        heaterOff();
        System.out.println("done");
    }

    public void shutdown() {
        running = false;
    }
    
    
    private double getTemp(){
        try{
        Process p = Runtime.getRuntime().exec("sudo python " + PATH_TO_TEMP + " 2302 17");
        BufferedReader stdInput = new BufferedReader(new InputStreamReader(p.getInputStream()));
        
        String consoleOutput = stdInput.readLine();//For some reason only 15 works with library
        //System.out.println(consoleOutput);
        consoleOutput = consoleOutput.substring(5,9);
        return Double.parseDouble(consoleOutput);
    }catch(IOException e){
        System.out.println("Error could not read temp");
        return -1;
    }
    }
    
    private void heaterOn(){
        if(!isRelayOn){
            //Turn relay on
            System.out.println("Heater is on");
            //relay.setHIGH();
            //pin.high();
            try{
            Process pOn = Runtime.getRuntime().exec("sudo python " + PATH_TO_RELAY_ON + " " + RELAY_PIN);
        }catch(IOException e){
              System.out.println("Error could not turn on");
        }
            isRelayOn = true;
        }
    }
    
    private void heaterOff(){
        if(isRelayOn){
            //turn Relay off
            System.out.println("Heater is off");
            //relay.setLOW();
            //pin.low();
            try{
            	Process pOff = Runtime.getRuntime().exec("sudo python " + PATH_TO_RELAY_OFF + " " + RELAY_PIN);
             }catch(IOException e){
            	 System.out.println("Error could not turn off");
             }
            isRelayOn = false;
        }
        
    }
    
    public void updateTarget(double newTarget){
        target = newTarget;
        System.out.println("new target:" + target);
    }
    
    public void updateThreshold(double newThreshold){
        threshold = newThreshold;
        System.out.println("new threshold:" + threshold);
    }
    
}
